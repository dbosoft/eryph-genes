name: linux-install

variables:
  - name: downloadUrl
    required: true
  - name: sshPublicKey
    required: true

fodder:
- name: install-egs
  type: shellscript
  content: |
    #!/usr/bin/env bash
    set -euo pipefail
    wget -O egs-linux.tar.gz '{{ downloadUrl }}'

    mkdir -p /opt/eryph/guest-services
    tar -xf egs-linux.tar.gz -C /opt/eryph/guest-services
    rm egs-linux.tar.gz
    chmod +x /opt/eryph/guest-services/egs

- name: write-files
  type: cloud-config
  content:
    write_files:
      - path: /etc/systemd/system/eryph-guest-services.service
        content: |
          [Unit]
          Description=eryph guest services

          [Service]
          Type=notify
          ExecStart=/opt/eryph/guest-services/egs

          [Install]
          WantedBy=multi-user.target
      - path: /etc/opt/eryph/guest-services/egs.pub
        content: '{{ sshPublicKey }}'

- name: enable-systemd-unit
  type: shellscript
  content: |
    #!/usr/bin/env bash
    set -euo pipefail
    systemctl daemon-reload
    systemctl enable eryph-guest-services.service
    systemctl start eryph-guest-services.service
